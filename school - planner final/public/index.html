<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>School Planner Multi-User</title>
<link rel="stylesheet" href="styles.css">
</head>
<body>

<h1 id="schoolHeader">
  <img id="schoolLogo" src="logos/trio.jpg" alt="School Logo" style="height:50px; vertical-align:middle; margin-right:10px;">
  <span id="schoolName">Trio</span>
</h1>

<!-- Role Selection -->
<label>Select Role:</label>
<select id="role">
    <option value="admin">Admin</option>
    <option value="teacher">Teacher</option>
    <option value="student">Student/Parent</option>
</select>
<br><br>

<!-- Admin Login -->
<div id="adminForm" style="display:none;">
    <h3>Admin Login</h3>
    <input type="email" id="adminEmail" placeholder="Email"><br>
    <input type="password" id="adminPassword" placeholder="Password"><br>
    <button onclick="loginAdmin()">Login</button>
</div>

<!-- Teacher Login -->
<div id="teacherForm" style="display:none;">
    <h3>Teacher Login</h3>
    <input type="email" id="teacherEmail" placeholder="Email"><br>
    <input type="password" id="teacherPassword" placeholder="Password"><br>
    <button onclick="loginTeacher()">Login</button>
</div>

<!-- Student Login -->
<div id="studentForm" style="display:none;">
    <h3>Student/Parent Login</h3>
    <label>Grade:</label>
    <select id="studentGrade"></select>
    <label>Class:</label>
    <select id="studentClass"></select>
    <button onclick="loginStudent()">View Tasks</button>
</div>

<!-- Main App -->
<div id="app" style="display:none;">
  <h3 id="currentUser"></h3>

  <!-- Admin Controls -->
  <div id="adminControls" style="display:none;">
    <h3>Admin Panel</h3>
    <label>Teacher Name:</label>
    <input type="text" id="newTeacherName" placeholder="Enter teacher name"><br>
    <label>Email:</label>
    <input type="email" id="newTeacherEmail" placeholder="Enter teacher email"><br>
    <label>Password:</label>
    <input type="password" id="newTeacherPassword" placeholder="Enter password"><br>
    <button onclick="registerTeacher()">Add Teacher</button>
    
    <h3>Manage School</h3>
    <label>School Name:</label>
    <input type="text" id="schoolNameInput"><br>
    <label>School Logo:</label>
    <input type="file" id="schoolLogoInput"><br>
    <button onclick="updateSchoolInfo()">Update School Info</button>

    <!-- 🔹 Reset Teacher Password Feature -->
    <h3>Reset Teacher Password</h3>
    <label>Teacher Email:</label>
    <input type="email" id="resetTeacherEmail" placeholder="Enter teacher email"><br>
    <label>New Password:</label>
    <input type="password" id="resetTeacherPassword" placeholder="Enter new password"><br>
    <button onclick="resetTeacherPassword()">Reset Password</button>

    <button onclick="logoutAdmin()">Logout</button>
  </div>

  <!-- Teacher Controls -->
  <div id="teacherControls" style="display:none;">
    <label>Grade:</label>
    <select id="grade"></select>
    <label>Class:</label>
    <select id="class"></select><br>
    <label>Subject:</label>
    <input type="text" id="subject" placeholder="Math, English, etc."><br>
    <label>Task:</label>
    <input type="text" id="taskDesc" placeholder="Homework description"><br>
    <label>Due Date:</label>
    <input type="date" id="dueDate"><br>
    <button onclick="addTask()">Add Task</button>

    <h3>Announcements</h3>
    <input type="text" id="announcementMsg" placeholder="Write announcement">
    <label>Grade (optional):</label>
    <select id="announcementGrade"></select>
    <select id="announcementClass"></select>
    <button onclick="addAnnouncement()">Add Announcement</button>
    <ul id="announcementList"></ul>

    <button onclick="logoutTeacher()">Logout</button>
  </div>

  <!-- Student Announcements -->
  <div id="studentAnnouncements" style="display:block;">
    <h3>Announcements</h3>
    <ul id="studentAnnouncementList"></ul>
    <button onclick="logoutStudent()">Logout</button>
  </div>

  <h2>Tasks</h2>
  <ul id="taskList"></ul>
</div>

<script>
// -------------------- BASE URL --------------------
const BASE_URL = ''; // Works with Vercel API

let role = '';
let teacherId = '';
let teacherName = '';

function populateGradeClass() {
    const gradeSelects = [document.getElementById('grade'), document.getElementById('studentGrade'), document.getElementById('announcementGrade')];
    const classSelects = [document.getElementById('class'), document.getElementById('studentClass'), document.getElementById('announcementClass')];

    gradeSelects.forEach(sel => {
        sel.innerHTML = '';
        sel.add(new Option("All Grades", "all"));
        for(let g=1; g<=12; g++) sel.add(new Option(`Grade ${g}`, g));
    });

    classSelects.forEach(sel => {
        sel.innerHTML = '';
        sel.add(new Option("All Classes", "all"));
        for(let c=65;c<=90;c++) sel.add(new Option(String.fromCharCode(c), String.fromCharCode(c)));
    });
}

document.getElementById('role').addEventListener('change', function(){
    document.getElementById('adminForm').style.display = (this.value==='admin') ? 'block' : 'none';
    document.getElementById('teacherForm').style.display = (this.value==='teacher') ? 'block' : 'none';
    document.getElementById('studentForm').style.display = (this.value==='student') ? 'block' : 'none';
    document.getElementById('app').style.display = 'none';
});

// ---------- Admin ----------
function loginAdmin(){
    const email = document.getElementById('adminEmail').value;
    const password = document.getElementById('adminPassword').value;
    if(email==='admin@school.com' && password==='admin123'){
        role='admin';
        document.getElementById('app').style.display='block';
        document.getElementById('adminControls').style.display='block';
        document.getElementById('teacherControls').style.display='none';
        document.getElementById('studentAnnouncements').style.display='none';
        document.getElementById('currentUser').innerText = "Logged in as Admin";
        document.getElementById('adminForm').style.display='none';
    } else { alert('Invalid admin credentials!'); }
}
function logoutAdmin(){
    role=''; 
    document.getElementById('app').style.display='none';
    document.getElementById('adminControls').style.display='none';
    document.getElementById('currentUser').innerText='';
    document.getElementById('adminEmail').value='';
    document.getElementById('adminPassword').value='';
    document.getElementById('adminForm').style.display='block';
}

// ---------- Teacher ----------
function loginTeacher(){
    const email = document.getElementById('teacherEmail').value.trim();
    const password = document.getElementById('teacherPassword').value.trim();
    if(!email || !password){ alert('Fill all fields'); return; }

    fetch(`${BASE_URL}/api/login`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email,password})
    })
    .then(res=>res.json())
    .then(data=>{
        if(data.error){ alert(data.error); return; }
        teacherId = data.user.id;
        teacherName = data.user.name;
        role='teacher';
        document.getElementById('currentUser').innerText = `Logged in as Teacher: ${teacherName}`;
        document.getElementById('teacherControls').style.display='block';
        document.getElementById('adminControls').style.display='none';
        document.getElementById('studentAnnouncements').style.display='none';
        document.getElementById('app').style.display='block';
        document.getElementById('teacherForm').style.display='none';
        fetchTasks();
        fetchAnnouncements();
    })
    .catch(err=>{ console.error(err); alert('Error connecting to server'); });
}

function logoutTeacher(){
    role=''; teacherId=''; teacherName='';
    document.getElementById('app').style.display='none';
    document.getElementById('teacherControls').style.display='none';
    document.getElementById('currentUser').innerText='';
    document.getElementById('teacherEmail').value='';
    document.getElementById('teacherPassword').value='';
    document.getElementById('teacherForm').style.display='block';
}

// ---------- Student ----------
function loginStudent(){
    role='student';
    const grade = document.getElementById('studentGrade').value;
    const classLetter = document.getElementById('studentClass').value;
    document.getElementById('app').style.display='block';
    document.getElementById('teacherControls').style.display='none';
    document.getElementById('adminControls').style.display='none';
    document.getElementById('studentAnnouncements').style.display='block';
    fetchTasks(grade,classLetter);
    fetchAnnouncements(grade,classLetter);
    document.getElementById('studentForm').style.display='none';
}
function logoutStudent(){
    role='';
    document.getElementById('app').style.display='none';
    document.getElementById('studentForm').style.display='block';
    document.getElementById('studentAnnouncementList').innerHTML='';
    document.getElementById('taskList').innerHTML='';
}

// ---------- Admin Features ----------
function registerTeacher(){
    const name=document.getElementById('newTeacherName').value.trim();
    const email=document.getElementById('newTeacherEmail').value.trim();
    const password=document.getElementById('newTeacherPassword').value.trim();
    if(!name || !email || !password){ alert('Fill all fields'); return; }
    fetch(`${BASE_URL}/api/register`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({name,email,password})
    })
    .then(res=>res.json())
    .then(data=>alert(data.message || data.error))
    .catch(err=>console.error(err));
}

// Reset Teacher Password
function resetTeacherPassword(){
    const email=document.getElementById('resetTeacherEmail').value.trim();
    const newPassword=document.getElementById('resetTeacherPassword').value.trim();
    if(!email||!newPassword){ alert('Fill all fields'); return; }
    fetch(`${BASE_URL}/api/reset-password`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({email,newPassword})
    })
    .then(res=>res.json())
    .then(data=>alert(data.message || data.error))
    .catch(err=>console.error(err));
}

// ---------- Tasks ----------
function addTask(){
    const grade=document.getElementById('grade').value;
    const classLetter=document.getElementById('class').value;
    const subject=document.getElementById('subject').value.trim();
    const description=document.getElementById('taskDesc').value.trim();
    const dueDate=document.getElementById('dueDate').value;
    if(!grade||!classLetter||!subject||!description||!dueDate){ alert('Fill all fields'); return; }
    fetch(`${BASE_URL}/api/task`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({grade,classLetter,subject,description,dueDate,teacher:teacherName})
    })
    .then(res=>res.json())
    .then(data=>{ alert(data.message || data.error); fetchTasks(); })
    .catch(err=>console.error(err));
}

function fetchTasks(grade='all', classLetter='all'){
    fetch(`${BASE_URL}/api/task`)
    .then(res=>res.json())
    .then(tasks=>{
        let list = document.getElementById('taskList');
        list.innerHTML='';
        tasks.forEach(t=>{
            if((grade==='all' || t.grade==grade) && (classLetter==='all' || t.classLetter==classLetter)){
                const li = document.createElement('li');
                li.innerText=`${t.grade}${t.classLetter} - ${t.subject}: ${t.description} (Due: ${t.dueDate}) ${t.done?'✅':'❌'}`;
                if(role==='teacher'){
                    const doneBtn = document.createElement('button'); doneBtn.innerText='Toggle Done';
                    doneBtn.onclick=()=>toggleTaskDone(t.id);
                    li.appendChild(doneBtn);
                    const delBtn = document.createElement('button'); delBtn.innerText='Delete';
                    delBtn.onclick=()=>deleteTask(t.id);
                    li.appendChild(delBtn);
                }
                list.appendChild(li);
            }
        });
    })
    .catch(err=>console.error(err));
}

function toggleTaskDone(id){
    fetch(`${BASE_URL}/api/task/${id}/done`,{method:'PUT'})
    .then(res=>res.json())
    .then(()=>fetchTasks())
    .catch(err=>console.error(err));
}

function deleteTask(id){
    fetch(`${BASE_URL}/api/task/${id}`,{method:'DELETE'})
    .then(res=>res.json())
    .then(()=>fetchTasks())
    .catch(err=>console.error(err));
}

// ---------- Announcements ----------
function addAnnouncement(){
    const message=document.getElementById('announcementMsg').value.trim();
    const grade=document.getElementById('announcementGrade').value;
    const classLetter=document.getElementById('announcementClass').value;
    if(!message){ alert('Enter a message'); return; }
    fetch(`${BASE_URL}/api/announcement`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({message,grade,classLetter,teacher:teacherName})
    })
    .then(res=>res.json())
    .then(data=>{ alert(data.message||data.error); fetchAnnouncements(); })
    .catch(err=>console.error(err));
}

function fetchAnnouncements(grade='all',classLetter='all'){
    fetch(`${BASE_URL}/api/announcement`)
    .then(res=>res.json())
    .then(anns=>{
        const studentList=document.getElementById('studentAnnouncementList');
        const teacherList=document.getElementById('announcementList');
        studentList.innerHTML=''; teacherList.innerHTML='';
        anns.forEach(a=>{
            if((grade==='all'||a.grade==grade)&&(classLetter==='all'||a.classLetter==classLetter)){
                const li1=document.createElement('li'); li1.innerText=`${a.grade}${a.classLetter}: ${a.message} (by ${a.teacher})`; studentList.appendChild(li1);
                if(role==='teacher'){
                    const li2=document.createElement('li'); li2.innerText=`${a.grade}${a.classLetter}: ${a.message}`;
                    const delBtn=document.createElement('button'); delBtn.innerText='Delete';
                    delBtn.onclick=()=>deleteAnnouncement(a.id);
                    li2.appendChild(delBtn); teacherList.appendChild(li2);
                }
            }
        });
    })
    .catch(err=>console.error(err));
}

function deleteAnnouncement(id){
    fetch(`${BASE_URL}/api/announcement/${id}`,{method:'DELETE'})
    .then(()=>fetchAnnouncements())
    .catch(err=>console.error(err));
}

// ---------- School Info ----------
function updateSchoolInfo(){
    const name=document.getElementById('schoolNameInput').value.trim();
    const logoInput=document.getElementById('schoolLogoInput');
    if(name) document.getElementById('schoolName').innerText=name;
    if(logoInput.files.length>0){
        const reader=new FileReader();
        reader.onload=function(e){ document.getElementById('schoolLogo').src=e.target.result; };
        reader.readAsDataURL(logoInput.files[0]);
    }
}

// Populate grades/classes at load
populateGradeClass();
</script>

</body>
</html>
